<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>MLOps Governance — Admin</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22d3ee; --danger:#f43f5e; --ok:#22c55e }
  *{box-sizing:border-box} body{margin:0; font:14px/1.4 system-ui,Segoe UI,Roboto,sans-serif; background:#0b1020; color:var(--text)}
  header{padding:14px 18px; background:var(--bg); border-bottom:1px solid #1f2937; display:flex; gap:12px; align-items:center}
  header h1{font-size:16px; margin:0; letter-spacing:.3px}
  .badge{padding:2px 8px; border-radius:999px; font-size:12px; background:#0b3751; color:#7dd3fc}
  main{padding:16px; display:grid; gap:16px; grid-template-columns: 340px 1fr}
  .card{background:var(--card); border:1px solid #1f2937; border-radius:12px; padding:14px}
  .card h2{margin:0 0 8px 0; font-size:14px; color:#d1d5db}
  .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  input,select,button,textarea{background:#0b1222; color:var(--text); border:1px solid #233149; border-radius:8px; padding:8px 10px}
  input,select,textarea{width:100%}
  button{cursor:pointer}
  button.primary{background:#0b2a36; border-color:#164e63}
  button.accent{background:#082e2e; border-color:#155e75; color:#99f6e4}
  button.danger{background:#2a0b16; border-color:#7f1d1d; color:#fecaca}
  table{width:100%; border-collapse:collapse}
  th,td{padding:8px 10px; border-bottom:1px solid #1f2937; vertical-align:top}
  th{color:#9ca3af; text-align:left}
  .sev-high{color:#fecaca}
  .sev-medium{color:#fde68a}
  .sev-low{color:#c7d2fe}
  .status-open{color:#93c5fd}
  .status-acknowledged{color:#fde68a}
  .status-resolved{color:#86efac}
  .muted{color:var(--muted)}
  .pill{padding:2px 8px; border-radius:999px; border:1px solid #334155; font-size:12px}
  .col{display:flex; flex-direction:column; gap:8px}
  .hr{height:1px; background:#1f2937; margin:8px 0}
  .hint{font-size:12px; color:#9ca3af}
  .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
</style>
</head>
<body>
<header>
  <h1>MLOps Governance — Admin</h1>
  <span class="badge">runtime</span>
</header>

<main>
  <!-- LEFT COLUMN -->
  <div class="col">
    <div class="card">
      <h2>Login</h2>
      <div class="row">
        <input id="login-user" placeholder="username" value="alice"/>
        <select id="login-role">
          <option>admin</option><option>approver</option><option>viewer</option>
        </select>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="primary" onclick="login()">Sign in</button>
        <span id="login-status" class="hint"></span>
      </div>
      <div class="hint mono" id="token-preview" style="margin-top:6px;"></div>
    </div>

    <div class="card">
      <h2>Models</h2>
      <div class="row">
        <select id="model-select"></select>
        <button onclick="loadModels()">Refresh</button>
        <button class="primary" onclick="createModel()">Create model</button>
      </div>
      <div class="row">
        <button class="primary" onclick="loadAlerts()">Load Alerts</button>
        <button onclick="summary()">Summary</button>
      </div>
      <div class="hint" id="summary-box"></div>
    </div>

    <div class="card">
      <h2>Alert Ops</h2>
      <div class="row">
        <button onclick="ackSelected()">ACK selected</button>
        <button class="primary" onclick="resolveSelected()">Resolve selected</button>
      </div>
      <div class="row">
        <input id="comment-text" placeholder="add a comment…"/>
        <button onclick="commentSelected()">Comment</button>
      </div>
      <div class="row">
        <button class="danger" onclick="resolveAll()">Resolve ALL for model</button>
      </div>
    </div>

    <div class="card">
      <h2>Slack</h2>
      <div class="row">
        <input id="slack-url" placeholder="https://hooks.slack.com/services/…"/>
      </div>
      <div class="row">
        <button onclick="saveSlack()">Save</button>
        <button class="accent" onclick="testSlack()">Test</button>
      </div>
      <div class="hint" id="slack-hint"></div>
    </div>

    <div class="card">
      <h2>Scheduler</h2>
      <div class="row">
        <button onclick="monitorRun()">Run monitor now</button>
      </div>
      <div class="hint">Runs one pass using current snapshots & baselines.</div>
    </div>

    <div class="card">
      <h2>Policy</h2>

      <div class="row" style="gap:8px; align-items:center">
        <label class="muted">Target</label>
        <select id="policy-target">
          <option value="staging">staging</option>
          <option value="production" selected>production</option>
        </select>

        <button onclick="policyCheck()">Check</button>
        <button onclick="policyReload()">Reload</button>
        <button onclick="policyShow()">Show file</button>
      </div>

      <div id="policy-status" class="hint" style="margin-top:6px"></div>

      <div class="hr"></div>

      <div class="muted" style="margin:2px 0 4px">Blocks</div>
      <ul id="policy-blocks"></ul>

      <div class="muted" style="margin:10px 0 4px">Snapshot / Policy file</div>
      <pre id="policy-result" class="mono" style="max-height:240px; overflow:auto; background:#0b0b0b; padding:8px; border-radius:8px"></pre>
    </div>

    <div class="card">
      <h2>Audit & Reports</h2>

      <div class="row">
        <label class="muted">Generate audit pack for:</label>
        <button class="primary" onclick="auditPackGen(24)">Last 24h</button>
        <button onclick="auditPackGen(7*24)">Last 7d</button>
        <button onclick="auditPackGen(null)">All time</button>
      </div>

      <div class="row" style="margin-top:6px">
        <button onclick="listAuditPacks()">List packs</button>
        <span id="audit-pack-status" class="hint"></span>
      </div>

      <div class="hr"></div>

      <table id="audit-pack-table">
        <thead>
          <tr>
            <th>Name</th>
            <th style="width:120px">Size</th>
            <th style="width:200px">Modified (UTC)</th>
            <th style="width:110px"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>


    <div class="card">
    <h2>SLO checks</h2>
    <div class="row">
      <div class="col" style="gap:6px; width:100%">
        <div class="row">
          <label class="muted" style="min-width:130px">AUC ≥</label>
          <input id="slo-auc" placeholder="0.80" />
        </div>
        <div class="row">
          <label class="muted" style="min-width:130px">F1 ≥</label>
          <input id="slo-f1" placeholder="0.75" />
        </div>
        <div class="row">
          <label class="muted" style="min-width:130px">p95 latency (ms) ≤</label>
          <input id="slo-lat-ms" placeholder="200" />
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button class="primary" onclick="sloSave()">Save thresholds</button>
      <button onclick="sloLoad()">Load</button>
      <button class="danger" onclick="sloClear()">Clear</button>
    </div>

  <div class="hr"></div>

  <div class="row">
    <button onclick="sloCheckMeta()">Check (use metadata)</button>
    <button onclick="sloCheckManual()">Check (manual metrics)</button>
    <button class="accent" onclick="sloBreachQuick()">Quick breach test</button>
  </div>

  <div class="hint" id="slo-hint" style="margin-top:6px"></div>
</div>

    <div class="card">
      <h2>Quick Tests</h2>
      <div class="row">
        <button class="primary" onclick="dqMissing()">DQ Missing (22%)</button>
        <button onclick="psiDrift()">PSI Drift</button>
      </div>
      <div class="hint">These call your existing API to induce alerts for demo.</div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div class="card" style="min-height:420px">
    <h2>Alerts</h2>
    <div class="row" style="margin-bottom:8px">
      <span class="hint">Click a row to select; actions apply to the selection.</span>
    </div>
    <div class="row" style="margin-bottom:8px">
      <label class="muted">Status:</label>
      <select id="status-filter" style="max-width:160px">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="acknowledged">Acknowledged</option>
        <option value="resolved">Resolved</option>
      </select>
      <button onclick="loadAlerts()">Apply</button>
    </div>
    <table id="alerts-table">
      <thead>
        <tr>
          <th style="width:70px">ID</th>
          <th>Type</th>
          <th>Severity</th>
          <th>Status</th>
          <th>Message</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="hint" id="alerts-hint" style="margin-top:8px"></div>
  </div>
</main>

<script>
const Base = location.origin; // same origin as API
let token = localStorage.getItem("mlops_token") || "";
let selectedAlertId = null;

// ------------- helpers -------------
function authHeaders() {
  if (!token) return { "Content-Type":"application/json" };
  return { "Content-Type":"application/json", "Authorization":"Bearer " + token };
}
function setStatus(id, text) { const el = document.getElementById(id); if (el) el.textContent = text || ""; }
function fmtTS(s){ if(!s) return ""; try{return new Date(s).toLocaleString()}catch(e){return s} }
function byId(id){ return document.getElementById(id); }

// ------------- login -------------
async function login() {
  const username = byId("login-user").value || "alice";
  const role = byId("login-role").value || "admin";
  const res = await fetch(Base + "/auth/login", {
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ username, role })
  });
  if (!res.ok) { setStatus("login-status","login failed"); return; }
  const data = await res.json();
  token = data.access_token; localStorage.setItem("mlops_token", token);
  setStatus("login-status","signed in as "+username+" ("+role+")");
  byId("token-preview").textContent = (token || "").slice(0,28) + (token ? "…" : "");
  loadModels();
}

// ------------- models -------------
async function loadModels() {
  const res = await fetch(Base + "/api/models", { headers: authHeaders() });
  const data = await res.json();
  const sel = byId("model-select");
  sel.innerHTML = "";
  data.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.id; opt.textContent = `#${m.id} — ${m.name} [${m.stage}]`;
    sel.appendChild(opt);
  });
  if (data.length) { sel.value = data[0].id; await loadAlerts(); }
}

async function createModel(){
  const name = prompt("Model name:", "demo_"+Math.floor(Math.random()*10000));
  if(!name) return;
  const version = prompt("Version:", "1.0.0") || "1.0.0";
  const desc = prompt("Description (optional):", "demo");
  const res = await fetch(Base + "/api/models", {
    method:"POST", headers: authHeaders(),
    body: JSON.stringify({ name, version, description: desc || null })
  });
  if(!res.ok){
    const t = await res.text();
    alert("create failed: " + t);
    return;
  }
  const m = await res.json();
  // Optional: promote to production so monitor picks it up
  await fetch(Base + `/api/models/${m.id}/stage?stage=production`, { method:"POST", headers: authHeaders() });
  await loadModels();
  alert(`Created model #${m.id} (${m.name}) and set to production`);
}

// ------------- alerts -------------
async function loadAlerts() {
  const mid = byId("model-select").value;
  const status = byId("status-filter") ? byId("status-filter").value : "";
  const q = status ? `&status=${encodeURIComponent(status)}` : "";
  const res = await fetch(Base + `/api/alerts?model_id=${mid}${q}`, { headers: authHeaders() });
  const rows = await res.json();
  const tbody = byId("alerts-table").querySelector("tbody");
  tbody.innerHTML = "";
  selectedAlertId = null;
  rows.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${a.id}</td>
      <td>${a.type}</td>
      <td class="mono ${"sev-"+a.severity}">${a.severity}</td>
      <td class="mono ${"status-"+a.status}">${a.status}</td>
      <td>${a.message}</td>
      <td class="mono">${fmtTS(a.created_at)}</td>`;
    tr.onclick = () => {
      [...tbody.children].forEach(r => r.style.background = "");
      tr.style.background = "#0e1a2f";
      selectedAlertId = a.id;
    };
    tbody.appendChild(tr);
  });
  setStatus("alerts-hint", rows.length ? `${rows.length} alert(s)` : "No alerts");
}

async function ackSelected(){
  if(!selectedAlertId){ alert("Select a row first"); return; }
  const res = await fetch(Base + `/api/alerts/${selectedAlertId}/ack`, { method:"POST", headers: authHeaders() });
  if(res.ok){ await loadAlerts(); } else { alert("ACK failed"); }
}
async function resolveSelected(){
  if(!selectedAlertId){ alert("Select a row first"); return; }
  const res = await fetch(Base + `/api/alerts/${selectedAlertId}/resolve`, { method:"POST", headers: authHeaders() });
  if(res.ok){ await loadAlerts(); } else { alert("Resolve failed"); }
}
async function commentSelected(){
  if(!selectedAlertId){ alert("Select a row first"); return; }
  const txt = byId("comment-text").value.trim();
  if(!txt){ alert("Enter a comment"); return; }
  const res = await fetch(Base + `/api/alerts/${selectedAlertId}/comment`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ comment: txt })
  });
  if(res.ok){ byId("comment-text").value=""; alert("Comment added (see audit)"); }
  else { alert("Comment failed"); }
}
async function resolveAll(){
  const mid = byId("model-select").value;
  if(!confirm("Resolve ALL alerts for this model?")) return;
  const res = await fetch(Base + `/api/models/${mid}/alerts/resolve_all`, { method:"POST", headers: authHeaders() });
  if(res.ok){ await loadAlerts(); } else { alert("Resolve-all failed"); }
}

async function summary(){
  const mid = byId("model-select").value;
  const res = await fetch(Base + `/api/models/${mid}/alerts/summary`, { headers: authHeaders() });
  if(!res.ok){ setStatus("summary-box","summary failed"); return; }
  const s = await res.json();
  setStatus("summary-box", `total ${s.total} — status: ${JSON.stringify(s.by_status)} — severity: ${JSON.stringify(s.by_severity)}`);
}

// ------------- slack -------------
async function saveSlack(){
  const url = byId("slack-url").value.trim();
  if(!url){ alert("Enter webhook URL"); return; }
  const res = await fetch(Base + "/config/slack-webhook", {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ webhook_url: url })
  });
  const d = await res.json();
  setStatus("slack-hint", d.saved ? "Webhook saved" : "Save failed");
}
async function testSlack(){
  const res = await fetch(Base + "/debug/slack", { method:"POST", headers: authHeaders() });
  const d = await res.json();
  setStatus("slack-hint", `sent=${d.sent} configured=${d.configured}`);
}

// ------------- scheduler -------------
async function monitorRun(){
  const res = await fetch(Base + "/admin/monitor/run", { method:"POST", headers: authHeaders() });
  if(res.ok){ await loadAlerts(); } else { alert("Monitor run failed"); }
}

// --------- Policy helpers (NEW) ---------
async function policyCheck(){
  const target = byId("policy-target").value;
  const res = await fetch(Base + `/api/models/${mid()}/policy/check?target=${encodeURIComponent(target)}`, {
    headers: authHeaders()
  });
  const d = await res.json();
  if(!res.ok){
    setStatus("policy-status", d.detail || "policy check failed");
    return;
  }
  // status headline
  setStatus("policy-status", d.allow ? "ALLOW ✅" : "BLOCK ❌");

  // render blocks
  const ul = byId("policy-blocks");
  ul.innerHTML = "";
  (d.blocks || []).forEach(b => {
    const li = document.createElement("li");
    li.textContent = `${b.rule} — ${b.reason}${b.waived ? " (waived)" : ""}`;
    ul.appendChild(li);
  });

  // snapshot (open alerts, slo, etc.)
  byId("policy-result").textContent = JSON.stringify(d.snapshot || {}, null, 2);
}

async function policyReload(){
  const res = await fetch(Base + `/api/policy/reload`, {
    method: "POST",
    headers: authHeaders()
  });
  const d = await res.json().catch(()=>({}));
  setStatus("policy-status", res.ok ? "reloaded ✅" : (d.detail || "reload failed"));
}

async function policyShow(){
  const res = await fetch(Base + `/api/policy`, { headers: authHeaders() });
  const d = await res.json();
  byId("policy-result").textContent = JSON.stringify(d, null, 2);
  setStatus("policy-status", res.ok ? "loaded policy.yaml" : "load failed");
}

function iso(date){ return date.toISOString().slice(0,19); }

async function auditPackGen(hours){
  const id = mid();
  let start=null, end=null;
  if(hours != null){
    const e = new Date();                  // now
    const s = new Date(e.getTime() - hours*3600*1000);
    start = iso(s); end = iso(e);
  }
  const qs = (start && end) ? `?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}` : "";
  const res = await fetch(Base + `/api/models/${id}/audit-pack${qs}`, { headers: authHeaders() });
  const d = await res.json();
  if(!res.ok){
    setStatus("audit-pack-status", d.detail || "generation failed");
    return;
  }
  setStatus("audit-pack-status", `generated → ${d._saved_to || "saved"}`);
  await listAuditPacks();
}

async function listAuditPacks(){
  const res = await fetch(Base + `/api/audit-packs`, { headers: authHeaders() });
  const rows = await res.json();
  const tbody = document.querySelector("#audit-pack-table tbody");
  tbody.innerHTML = "";
  rows.forEach(r => {
    const tr = document.createElement("tr");
    const kb = Math.max(1, Math.round((r.size_bytes||0)/1024));
    tr.innerHTML = `
      <td class="mono">${r.name}</td>
      <td>${kb} KB</td>
      <td class="mono">${r.modified}</td>
      <td><a href="${Base}/api/audit-packs/${encodeURIComponent(r.name)}" target="_blank">Download</a></td>
    `;
    tbody.appendChild(tr);
  });
  setStatus("audit-pack-status", `${rows.length} pack(s)`);
}

// ------------- quick tests -------------
async function dqMissing(){
  const mid = byId("model-select").value;
  const body = { feature:"zipcode_admin", total_count:1000, missing_count:220 };
  const res = await fetch(Base + `/api/models/${mid}/drift/dq/missing`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify(body)
  });
  await loadAlerts();
}
async function psiDrift(){
  const mid = byId("model-select").value;
  // baseline first (idempotent if it exists)
  await fetch(Base + `/api/models/${mid}/drift/baseline`, {
    method:"POST", headers: authHeaders(),
    body: JSON.stringify({ feature:"age_bucket_admin", expected:[0.10,0.20,0.30,0.25,0.15] })
  });
  // evaluate drift
  await fetch(Base + `/api/models/${mid}/drift/psi`, {
    method:"POST", headers: authHeaders(),
    body: JSON.stringify({ feature:"age_bucket_admin", actual:[0.05,0.10,0.18,0.32,0.35] })
  });
  await loadAlerts();
}

// ------------- boot -------------
(function init(){
  if(token){ byId("token-preview").textContent = (token||"").slice(0,28) + "…"; }
  loadModels().catch(()=>{ /* ignore until login */ });
})();

function mid(){ return byId("model-select").value; }
function n(x){ const v = parseFloat(x); return isFinite(v) ? v : undefined; }

async function sloLoad(){
  const res = await fetch(Base + `/api/models/${mid()}/slo`, { headers: authHeaders() });
  if(!res.ok){ setStatus("slo-hint","load failed"); return; }
  const d = await res.json();
  const thr = d.thresholds || {};
  byId("slo-auc").value    = (thr.auc ?? "");
  byId("slo-f1").value     = (thr.f1 ?? "");
  byId("slo-lat-ms").value = (thr.latency_p95_ms ?? "");
  setStatus("slo-hint","loaded");
}

async function sloSave(){
  const thresholds = {};
  const auc = n(byId("slo-auc").value);
  const f1  = n(byId("slo-f1").value);
  const p95 = n(byId("slo-lat-ms").value);
  if(auc !== undefined) thresholds.auc = auc;
  if(f1  !== undefined) thresholds.f1  = f1;
  if(p95 !== undefined) thresholds.latency_p95_ms = p95;

  if(!Object.keys(thresholds).length){ alert("Enter at least one threshold"); return; }

  const body = { thresholds: thresholds, directions: { latency_p95_ms: "le" } };
  const res = await fetch(Base + `/api/models/${mid()}/slo/thresholds`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify(body)
  });
  const d = await res.json();
  if(res.ok){ setStatus("slo-hint", `saved: ${d.threshold_keys.join(", ")}`) }
  else { setStatus("slo-hint", "save failed"); }
}

async function sloClear(){
  if(!confirm("Clear SLO thresholds for this model?")) return;
  const res = await fetch(Base + `/api/models/${mid()}/slo`, { method:"DELETE", headers: authHeaders() });
  if(res.ok){ setStatus("slo-hint","cleared"); }
  else { setStatus("slo-hint","clear failed"); }
}

async function sloCheckMeta(){
  const res = await fetch(Base + `/api/models/${mid()}/slo/check`, {
    method:"POST", headers: authHeaders(), body: "{}"
  });
  const d = await res.json();
  if(res.ok){
    const extra = d.severity ? ` • severity=${d.severity}` : "";
    setStatus("slo-hint", `violations=${d.violations}${extra} (metric_id=${d.metric_id}${d.alert_id? " alert_id="+d.alert_id:""})`);
    await loadAlerts();
  } else {
    setStatus("slo-hint","check failed: "+(d.detail||res.statusText));
  }
}

async function sloCheckManual(){
  // read manual *metrics* from the same inputs you used as thresholds (demo-friendly)
  const metrics = {};
  const auc = n(byId("slo-auc").value);
  const f1  = n(byId("slo-f1").value);
  const p95 = n(byId("slo-lat-ms").value);
  if(auc !== undefined) metrics.auc = auc;
  if(f1  !== undefined) metrics.f1  = f1;
  if(p95 !== undefined) metrics.latency_p95_ms = p95;

  if(!Object.keys(metrics).length){ alert("Enter at least one metric value"); return; }

  const res = await fetch(Base + `/api/models/${mid()}/slo/check`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify({ metrics })
  });
  const d = await res.json();
  if(res.ok){
    const extra = d.severity ? ` • severity=${d.severity}` : "";
    setStatus("slo-hint", `violations=${d.violations}${extra} (metric_id=${d.metric_id}${d.alert_id? " alert_id="+d.alert_id:""})`);
    await loadAlerts();
  } else {
    setStatus("slo-hint","check failed: "+(d.detail||res.statusText));
  }
}

async function sloBreachQuick(){
  // 1) set thresholds (idempotent)
  const thr = { thresholds: { auc: 0.80, f1: 0.75, latency_p95_ms: 200 }, directions: { latency_p95_ms: "le" } };
  await fetch(Base + `/api/models/${mid()}/slo/thresholds`, {
    method:"POST", headers: authHeaders(), body: JSON.stringify(thr)
  });

  // 2) sync *bad* metrics into model metadata (so status pages also reflect activity)
  await fetch(Base + `/api/integrations/mlflow/sync`, {
    method:"POST", headers: authHeaders(),
    body: JSON.stringify({ model_id: parseInt(mid()), metrics: { auc: 0.74, f1: 0.71, latency_p95_ms: 240 } })
  });

  // 3) run the check (metadata-based)
  await sloCheckMeta();
}

</script>
</body>
</html>
